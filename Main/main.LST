C51 COMPILER V9.52.0.0   MAIN                                                              06/30/2021 20:16:34 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include <REGX51.H>
   2          //Khai bao ket noi IC 74595
   3          
   4          sbit IDX0_IC595_SHCP = P0^0;    //xung clock
   5          sbit IDX0_IC595_DS = P0^1;    // chan data
   6          sbit IDX0_IC595_STCP = P0^2;  // chan chot du lieu 
   7          
   8          sbit IDX1_IC595_SHCP = P0^3;    //xung clock
   9          sbit IDX1_IC595_DS = P0^4;    // chan data
  10          sbit IDX1_IC595_STCP = P0^5;  // chan chot du lieu 
  11          
  12          sbit IDX2_IC595_SHCP = P1^0;    //xung clock
  13          sbit IDX2_IC595_DS = P1^1;    // chan data
  14          sbit IDX2_IC595_STCP = P1^2;  // chan chot du lieu 
  15          
  16          sbit IDX3_IC595_SHCP = P1^3;    //xung clock
  17          sbit IDX3_IC595_DS = P1^4;    // chan data
  18          sbit IDX3_IC595_STCP = P1^5;  // chan chot du lieu 
  19          
  20          sbit ledStart = P3^4;
  21          sbit ledUart = P3^5;
  22          sbit button = P3^6;
  23          sbit led1 = P3^7;
  24          sbit ledCustom = P1^7 ;
  25          sbit ledCheck = P1^6 ;
  26          
  27          unsigned char STATE_595_0 = 0x00;
  28          unsigned char STATE_595_1 = 0x00;
  29          unsigned char STATE_595_2 = 0x00;
  30          unsigned char STATE_595_3 = 0x00;
  31          ////////////////////////////////
  32          unsigned char r_data;
  33          unsigned char START_BYTE= 0;
  34          unsigned char MODE= 0;
  35          unsigned char Count = 0 ;
  36          ////////////////////////////////
  37          unsigned char isReceiveLength =  0;
  38          unsigned char lengthOfEffect = 0 ;
  39          unsigned char storage[10] = {0xff, 0xff, 0xff ,0xff, 0x50, 0x00, 0x00, 0x00 ,0x00, 0x50} ;
  40          // unsigned char isStateOrDelay = 0 ; // = 0 means wait for led value, =1 means wait for delay value
  41          
  42          
  43          
  44          void OUT_BYTE_LED(unsigned char value, unsigned char idx)
  45          {
  46   1        if (idx == 0)
  47   1        {
  48   2          unsigned char i;
  49   2          STATE_595_0 = value;
  50   2          for (i = 0 ; i < 8 ; i++)
  51   2          {
  52   3            IDX0_IC595_DS = !(value & (0x80 >>i));
  53   3            IDX0_IC595_SHCP = 1;
  54   3            IDX0_IC595_SHCP = 0 ;
  55   3          }
C51 COMPILER V9.52.0.0   MAIN                                                              06/30/2021 20:16:34 PAGE 2   

  56   2          IDX0_IC595_STCP = 1 ;
  57   2          IDX0_IC595_STCP = 0 ; 
  58   2        }
  59   1        else if (idx == 1)
  60   1        {
  61   2          unsigned char i;
  62   2          STATE_595_1 = value;
  63   2          for (i = 0 ; i < 8 ; i++)
  64   2          {
  65   3            IDX1_IC595_DS = !(value & (0x80 >>i));
  66   3            IDX1_IC595_SHCP = 1;
  67   3            IDX1_IC595_SHCP = 0 ;
  68   3          }
  69   2          IDX1_IC595_STCP = 1 ;
  70   2          IDX1_IC595_STCP = 0 ; 
  71   2        }
  72   1        else if (idx == 2)
  73   1        {
  74   2          unsigned char i;
  75   2          STATE_595_2 = value;
  76   2          for (i = 0 ; i < 8 ; i++)
  77   2          {
  78   3            IDX2_IC595_DS = !(value & (0x80 >>i));
  79   3            IDX2_IC595_SHCP = 1;
  80   3            IDX2_IC595_SHCP = 0 ;
  81   3          }
  82   2          IDX2_IC595_STCP = 1 ;
  83   2          IDX2_IC595_STCP = 0 ; 
  84   2        }
  85   1        
  86   1        else 
  87   1        {
  88   2          unsigned char i;
  89   2          STATE_595_3 = value;
  90   2          for (i = 0 ; i < 8 ; i++)
  91   2          {
  92   3            IDX3_IC595_DS = !(value & (0x80 >>i));
  93   3            IDX3_IC595_SHCP = 1;
  94   3            IDX3_IC595_SHCP = 0 ;
  95   3          }
  96   2          IDX3_IC595_STCP = 1 ;
  97   2          IDX3_IC595_STCP = 0 ; 
  98   2        }
  99   1        
 100   1        
 101   1      }
 102          
 103          
 104          
 105          void OUT_BIT_LED(unsigned char idx, unsigned char idx_595)
 106          {
 107   1        if (idx_595 == 0)
 108   1        {
 109   2          STATE_595_0 |= (0x01 << idx) ; 
 110   2          OUT_BYTE_LED(STATE_595_0, idx_595);
 111   2        }
 112   1        else if (idx_595 == 1)
 113   1        {
 114   2          STATE_595_1 |= (0x01 << idx) ; 
 115   2          OUT_BYTE_LED(STATE_595_1, idx_595);
 116   2        }
 117   1        else if (idx_595 == 2)
C51 COMPILER V9.52.0.0   MAIN                                                              06/30/2021 20:16:34 PAGE 3   

 118   1        {
 119   2          STATE_595_2 |= (0x01 << idx) ; 
 120   2          OUT_BYTE_LED(STATE_595_2, idx_595);
 121   2        }
 122   1        else 
 123   1        {
 124   2          STATE_595_3 |= (0x01 << idx) ; 
 125   2          OUT_BYTE_LED(STATE_595_3, idx_595);
 126   2        }
 127   1      }
 128           /////////////////////////////
 129          
 130          
 131          //khoi tao
 132          void UART_Init()
 133          {
 134   1        TMOD = 0x20;    /* Timer 1, 8-bit auto reload mode */
 135   1        TH1 = 0xFD;   /* Load value for 9600 baud rate */ //F3
 136   1        SCON = 0x50;    /* Mode 1, reception enable */
 137   1        TR1 = 1;
 138   1        IE=0X90;    /* Start timer 1 */
 139   1      }
 140          
 141          
 142          void HardMode_Handler(unsigned char Data)
 143          {
 144   1        if (Data >= 0 && Data < 256)
 145   1        {
 146   2          OUT_BYTE_LED(Data, Count);
 147   2          Count++;
 148   2          if (Count == 4)
 149   2          {
 150   3            Count = 0 ;         
 151   3            START_BYTE = 0 ;
 152   3            MODE = 0 ;              // clear mode
 153   3          }
 154   2        }
 155   1        else
 156   1        {
 157   2          // Out of range data 307,2
 158   2          // led on
 159   2        }
 160   1      }
 161          
 162          void CustomMode_Handler(unsigned char Data)
 163          {
 164   1        if (isReceiveLength == 0)
 165   1        {
 166   2          lengthOfEffect = Data;
 167   2          isReceiveLength = 1;
 168   2        }
 169   1        else
 170   1        {
 171   2          if (Count == lengthOfEffect * 5)
 172   2          {
 173   3            OUT_BYTE_LED(0xff,0);
 174   3            START_BYTE = 0 ;            // nhan du roi clear mode
 175   3            MODE = 0 ;              
 176   3          }
 177   2          else
 178   2          {
 179   3            ledCheck = ~ledCheck;
C51 COMPILER V9.52.0.0   MAIN                                                              06/30/2021 20:16:34 PAGE 4   

 180   3            storage[Count] = Data; 
 181   3            Count++ ;
 182   3          }
 183   2          
 184   2        }
 185   1      }
 186          
 187          
 188          void Receive_Handler(unsigned char Data)
 189          {
 190   1        TI = 0 ;                // send uart de kiem tra
 191   1        Data -= 0x30;           // se xoa 
 192   1        SBUF = Data ; 
 193   1        while(TI ==0);
 194   1        TI = 0;
 195   1        if (START_BYTE == 0 && Data == 0)     // chua co du lieu va nhan duoc start_byte
 196   1        {
 197   2          ledCustom = 0;
 198   2          isReceiveLength = 0;                // clear custom
 199   2          Count = 0 ;
 200   2          ledStart = 1 ;
 201   2          START_BYTE = 1;
 202   2        }
 203   1        else if (START_BYTE == 1 && MODE == 0 && (Data > 0 && Data < 5))  // neu da start va mode chua co, thi ch
             -eck xem mode byte co dung format k __ mode 1 mode 2
 204   1        {
 205   2          MODE = Data;
 206   2        }
 207   1        else if (START_BYTE !=0 && MODE != 0)
 208   1        {
 209   2          if (MODE == 1 || MODE == 2 || MODE == 3)
 210   2          {
 211   3            ledCustom = 0;
 212   3            HardMode_Handler(Data);
 213   3          }
 214   2          else if (MODE == 4)
 215   2          {
 216   3            ledCustom = ~ledCustom;
 217   3            CustomMode_Handler(Data);
 218   3          }
 219   2          
 220   2          else
 221   2          {
 222   3            // Turn on LED
 223   3            // should not reach here
 224   3          }
 225   2        }
 226   1        else        // chua hop sai
 227   1        {
 228   2          ledCustom = 0;
 229   2          ledStart = 0 ;
 230   2          START_BYTE = 0 ;
 231   2          MODE = 0 ;
 232   2        }
 233   1        RI = 0;
 234   1      }
 235          
 236          
 237          void Custom_delay (unsigned char delayTime)
 238          {
 239   1        unsigned char k ; 
 240   1        for (k = 0 ; k < delayTime*10; k ++)
C51 COMPILER V9.52.0.0   MAIN                                                              06/30/2021 20:16:34 PAGE 5   

 241   1        {
 242   2          TMOD = 0x21; 
 243   2          TF0 = 0; 
 244   2          TH0 = 0xfc ; 
 245   2          TL0 = 0x66; // thach anh = 12 TL0 = 0x18;
 246   2          TR0 = 1; 
 247   2          while(!TF0);
 248   2          TF0 = 0; 
 249   2          TR0 = 0 ;
 250   2        }
 251   1      }
 252          
 253          
 254          void ISR_UART(void) interrupt 4
 255          {
 256   1        if(RI == 1)           //Kiem tra xem la ngat nhan hay truyen
 257   1        { 
 258   2          ledUart = ~ledUart;
 259   2          r_data = SBUF;          //nhan du lieu
 260   2          Receive_Handler(r_data);
 261   2        }
 262   1      
 263   1        else if (TI==1)
 264   1        {
 265   2          TI=0;
 266   2        }
 267   1      }
 268          
 269          
 270          
 271          
 272          
 273          void main()
 274          {
 275   1        
 276   1      //  // INIT 32 LED
 277   1        OUT_BYTE_LED(0x00,0);
 278   1        OUT_BYTE_LED(0x00,1);
 279   1        OUT_BYTE_LED(0x00,2);
 280   1        OUT_BYTE_LED(0x00,3);
 281   1        
 282   1        OUT_BYTE_LED(0x00,0);
 283   1        OUT_BYTE_LED(0x00,1);
 284   1        OUT_BYTE_LED(0x00,2);
 285   1        OUT_BYTE_LED(0x00,3);
 286   1        
 287   1        UART_Init();
 288   1           
 289   1        while(1)
 290   1        {
 291   2          /*
 292   2          unsigned char i;
 293   2          //if (Count == lengthOfEffect * 5 && isReceiveLength == 1)          // neu da nhan duoc tin hieu thi 
 294   2          //{
 295   2            //MODE = 0 ;            // clear and wait for another mode
 296   2            //START_BYTE = 0 ; 
 297   2            
 298   2            for (i = 0 ; i < 10 ; i++)
 299   2            {
 300   2              TI = 0 ;                // send uart de kiem tra
 301   2              SBUF = i ; 
 302   2              while(TI ==0);
C51 COMPILER V9.52.0.0   MAIN                                                              06/30/2021 20:16:34 PAGE 6   

 303   2              TI = 0;
 304   2              if (i % 5 == 4)       
 305   2              {
 306   2                Custom_delay(storage[i]);
 307   2              }
 308   2              else
 309   2              {
 310   2                OUT_BYTE_LED(0x0f, i % 5);
 311   2              }
 312   2            }
 313   2          //}
 314   2            
 315   2            */
 316   2            OUT_BYTE_LED(0x00,0);
 317   2            OUT_BYTE_LED(0x00,1);
 318   2            OUT_BYTE_LED(0x00,2);
 319   2            OUT_BYTE_LED(0x00,3);
 320   2            Custom_delay(200);
 321   2            OUT_BYTE_LED(0xf0,0);
 322   2            OUT_BYTE_LED(0xf0,1);
 323   2            OUT_BYTE_LED(0xf0,2);
 324   2            OUT_BYTE_LED(0xf0,3);
 325   2        }
 326   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    714    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     20       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
